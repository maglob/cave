<html>
<head>
<title>Cave</title>
<script>
frame=0
ship={x:0, y:-0, a:90, vx:0, vy:0, controls: {left: false, right: false, thrust: false, shield: false}}

window.onkeydown = window.onkeyup = function (e) {
  var isDown = e.type == "keydown"
  switch(e.keyCode) {
  case 65: ship.controls.left = isDown; break;
  case 68: ship.controls.right = isDown; break;
  case 76: ship.controls.thrust = isDown; break;
  case 32: ship.controls.shield = isDown; break;
  }
}

function set(elementIdDotAttribute, value) {
  var a = elementIdDotAttribute.split('.')
  return document.getElementById(a[0]).setAttribute(a[1], value)
}

Array.prototype.scale = function(scale) {
  if (typeof scale == 'number')
    scale = [scale]
  for (var r=[],i=0; i<this.length; i++) 
    r.push(this[i] * scale[i % scale.length])
  return r
}

Array.prototype.add = function(b) {
  if (typeof b == 'number')
    b = [b]
  for (var r=[],i=0; i<this.length; i++) 
    r.push(this[i] + b[i % b.length])
  return r
}


Array.prototype.sub = function(b) {
  if (typeof b == 'number')
    b = [b]
  for (var r=[],i=0; i<this.length; i++) 
    r.push(this[i] - b[i % b.length])
  return r
}

Array.prototype.rotate = function(angle) {
  for (var r=[],i=0; i<this.length; i+=2) 
    r.push(this[i]*Math.cos(angle) - this[i+1]*Math.sin(angle),
	   (this[i]*Math.sin(angle) + this[i+1]*Math.cos(angle)))
  return r
}

Array.prototype.len = function() {
  return Math.sqrt(this[0]*this[0]+this[1]*this[1])
}

Array.prototype.unit = function() {
  return this.scale(1.0 / this.len())
}

Array.prototype.dot = function(b) {
  return this[0]*b[0] + this[1]*b[1];
}

Array.prototype.normal = function(b) {
  var r = b.sub(this)
  return [-r[1], r[0]].unit()
}


function createRegularPolygon(n) {
  for(var r=[],i=0; i<n; i++) {
    var a = Math.PI * 2 / n * i;
    r.push(Math.cos(a), Math.sin(a))
  }
  return r
}

Array.prototype.midpointDisplacement = function() {
  if (this.length >= 4) {
    var r = []
    for(i=0; i<=this.length-4; i+=2) {
      var a = this.slice(i, i+2)
      var b = this.slice(i+2, i+4)
      r.push(a[0], a[1])
      var n = a.normal(b)   
      var mp = a.add(b).scale(0.5)
      var len = b.sub(a).len() * 0.2
      var t = mp.add(n.scale(len-Math.random()*len*2))
      r.push(t[0], t[1])
    }
    r.push(this[i], this[i+1])
    return r
  }
}

// Repeat next method in chain n times
//   Example: [1,2,3].repeatNext(5).add(1) --> [6,7,8]
Array.prototype.repeatNext = function(n) {
  var proxy = {}
  var _this = this
  for(var i in this) 
    if (typeof(this[i]) == 'function' && !this.hasOwnProperty(i)) 
      proxy[i] = function(fn) {
        return function() {
          var res = _this;
          for(j=0; j<n; j++) 
            res = this[fn].apply(res, arguments)
          return res          
        };
      }(i);
  return proxy
}

function init() {
  set('ship.points', [20,0, -15,-12, -8,-3, -8,4, -15,12])
  set('cave.points', createRegularPolygon(6).scale([600, 300]).rotate(Math.PI/16).repeatNext(3).midpointDisplacement())
  set('shield.r', 26)
  tick()
}

function tick() {
  frame++
  if (ship.controls.left)
    ship.a += 6
  if (ship.controls.right)
    ship.a -= 6
  if (ship.controls.thrust) {
    ship.vx += Math.cos(Math.PI/180*ship.a)*.5
    ship.vy += Math.sin(Math.PI/180*ship.a)*.5
  }
  ship.vy -= 0.02
  ship.x += ship.vx
  ship.y += ship.vy
  var view = document.getElementById("view")
  set('viewport.transform', 'scale(1,-1) translate('+ (view.clientWidth/2-ship.x) +','+  (-view.clientHeight/2-ship.y) +')')
  set('ship.transform', 'translate('+ ship.x +','+ ship.y +') rotate('+ ship.a +')')
  set('shield.visibility', ship.controls.shield ? 'visible' : 'hidden')
  if (ship.controls.shield) {
    set('shield.transform', 'translate('+ ship.x +','+ ship.y +')')
    set('shield.stroke-dashoffset', frame*2)
  }
  setTimeout(tick, 50)
}


</script>
</head>
<body style="background-color: black" onLoad="init()">
<div id="view">
  <svg id="svg" width="99%" height="99%">
    <g id="viewport">
      <polygon id="cave" fill="none" stroke="white"/>
      <polygon id="ship" stroke="white"/>
      <circle id="shield" fill-opacity="0" stroke="white" stroke-dasharray="4 6"/>
    </g>
    <g id="console">
      <text x="10" y="15" stroke="white">A: turn left, D: turn right, L: thrust, Space: shield</text>
    </g>
  </svg>
</div>
</body>
</html>
